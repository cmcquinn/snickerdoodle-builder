#!/bin/bash

set -e # exit on error
set -x # echo commands

ROOTDIR="/tmp/multistrap"
CONFIGDIR="${PWD}/configs"
UTILSDIR="${PWD}/utils"

# add machinekit keys to trusted keys dir
mkdir -p ${ROOTDIR}/etc/apt/trusted.gpg.d
wget http://deb.machinekit.io/43DDF224.gpg.key | apt-key --keyring ${ROOTDIR}/etc/apt/trusted.gpg.d/machinekit.gpg add -

# multistrap
multistrap -f ${CONFIGDIR}/rootfs.conf -d ${ROOTDIR}

# prepare to chroot
cp $(which qemu-arm-static) ${ROOTDIR}
mount -o bind /dev/ ${ROOTDIR}/dev/

# run configurescript
LC_ALL=C LANGUAGE=C LANG=C chroot ${ROOTDIR} /bin/bash ${UTILSDIR}/configscript.sh

# create disk image

# partition disk image

# populate disk image

# install additional files under /etc

# archive the rootfs and upload to github