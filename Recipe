#!/bin/bash

set -e # exit on error
set -x # echo commands

PROJECTDIR="${PWD}"
ROOTDIR="/tmp/multistrap"
CONFIGDIR="${PROJECTDIR}/configs"
UTILSDIR="${PROJECTDIR}/utils"

# add machinekit keys to trusted keys dir
mkdir -p ${ROOTDIR}/etc/apt/trusted.gpg.d
apt-key --keyring "${ROOTDIR}/etc/apt/trusted.gpg.d/machinekit.gpg" adv --batch --keyserver hkp://keyserver.ubuntu.com:80 --recv 43DDF224

# multistrap
multistrap -f ${CONFIGDIR}/rootfs.conf -d ${ROOTDIR}

# prepare to chroot
cp $(which qemu-arm-static) ${ROOTDIR}/usr/bin
mkdir -p ${ROOTDIR}/${PROJECTDIR}
mount -o bind /dev ${ROOTDIR}/dev
mount -o bind /dev/pts ${ROOTDIR}/dev/pts
mount -o bind /sys ${ROOTDIR}/sys
mount -o bind ${PROJECTDIR} ${ROOTDIR}/${PROJECTDIR}

# run configurescript
LC_ALL=C LANGUAGE=C LANG=C chroot ${ROOTDIR} /bin/bash ${CONFIGDIR}/configscript.sh

# unbind chroot mounts
umount ${ROOTDIR}/{sys,proc,dev/pts,dev,${PROJECTDIR}}

# create disk image

# partition disk image

# populate disk image

# install additional files under /etc

# archive the rootfs and upload to github